<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurboConvert PRO | Batch</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #080808; --card: #141414; --text: #ffffff; --border: #222; --primary: #00dc82; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        
        .container { background: var(--card); padding: 30px; border-radius: 24px; width: 600px; border: 1px solid var(--border); position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .step { display: none; }
        .step.active { display: block; }

        /* Pro Label */
        .pro-label { position: absolute; top: 25px; right: 25px; font-size: 10px; font-weight: 900; color: var(--primary); border: 1.5px solid var(--primary); padding: 3px 10px; border-radius: 6px; letter-spacing: 2px; }

        /* Upload Area */
        .upload-box { border: 2px dashed #333; padding: 40px; border-radius: 20px; cursor: pointer; text-align: center; transition: 0.3s; background: #0f0f0f; }
        .upload-box:hover { border-color: var(--primary); background: #1a1a1a; }

        /* File List UI */
        #fileList { max-height: 250px; overflow-y: auto; margin: 20px 0; padding: 10px; background: #0a0a0a; border-radius: 12px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #222; font-size: 13px; }
        .file-item:last-child { border: none; }
        
        /* Controls */
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        select, button { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); font-size: 14px; outline: none; }
        select { background: #1a1a1a; color: white; }
        button { background: var(--primary); color: black; font-weight: bold; cursor: pointer; border: none; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Options */
        .options-bar { display: flex; gap: 15px; margin: 15px 0; font-size: 12px; color: #888; }
        .option-item { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .option-item input { accent-color: var(--primary); }

        /* Progress */
        .progress-wrapper { margin-top: 20px; display: none; }
        .status-text { font-size: 12px; color: var(--primary); margin-bottom: 8px; text-align: center; }
        .progress-container { background: #222; height: 6px; border-radius: 10px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <div class="pro-label">PRO</div>

    <div id="step1" class="step active">
        <h2 style="margin-top:0">Batch Turbo</h2>
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00dc82" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <p>Click to Select Multiple Files</p>
            <input type="file" id="fileInput" multiple style="display:none">
        </div>
        <p style="font-size: 11px; color: #555; margin-top: 20px;">Support for 50+ files at once • Local Processing</p>
    </div>

    <div id="step2" class="step">
        <h3 style="margin:0">Batch Processing</h3>
        <div id="fileList"></div>

        <div class="options-bar">
            <label class="option-item">
                <input type="checkbox" id="zipToggle" checked> Bundle in .ZIP
            </label>
            <label class="option-item">
                <input type="checkbox" id="autoDownload" checked> Auto-Download
            </label>
        </div>

        <div class="controls-grid">
            <div>
                <label style="font-size: 11px; color: #666; display: block; margin-bottom: 5px;">CONVERT ALL TO:</label>
                <select id="masterFormat">
                    <option value="mp4">MP4 Video</option>
                    <option value="mp3">MP3 Audio</option>
                    <option value="png">PNG Image</option>
                    <option value="jpg">JPG Image</option>
                    <option value="gif">GIF Animation</option>
                    <option value="webp">WebP Image</option>
                </select>
            </div>
            <div style="display: flex; align-items: flex-end;">
                <button id="startBatchBtn">Start Batch</button>
            </div>
        </div>

        <div class="progress-wrapper" id="progWrapper">
            <div class="status-text" id="statusMsg">Initializing FFmpeg...</div>
            <div class="progress-container">
                <div class="progress-bar" id="progBar"></div>
            </div>
        </div>

        <button onclick="location.reload()" style="background:none; color:#555; font-size:12px; margin-top: 15px; border:none;">← Cancel Batch</button>
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: false });
    let uploadedFiles = [];

    const fileInput = document.getElementById('fileInput');
    const fileListDiv = document.getElementById('fileList');
    const startBtn = document.getElementById('startBatchBtn');
    const progBar = document.getElementById('progBar');
    const statusMsg = document.getElementById('statusMsg');

    fileInput.addEventListener('change', (e) => {
        uploadedFiles = Array.from(e.target.files);
        if (uploadedFiles.length > 0) {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            renderFileList();
        }
    });

    function renderFileList() {
        fileListDiv.innerHTML = uploadedFiles.map(f => `
            <div class="file-item">
                <span>${f.name}</span>
                <span style="color: #666;">${(f.size / 1024 / 1024).toFixed(2)} MB</span>
            </div>
        `).join('');
    }

    async function processBatch() {
        const targetFormat = document.getElementById('masterFormat').value;
        const useZip = document.getElementById('zipToggle').checked;
        const zip = new JSZip();
        
        document.getElementById('progWrapper').style.display = 'block';
        startBtn.disabled = true;

        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        for (let i = 0; i < uploadedFiles.length; i++) {
            const file = uploadedFiles[i];
            const inName = file.name;
            const outName = `turbo_${i}.${targetFormat}`;
            const finalDownloadName = `${file.name.split('.')[0]}.${targetFormat}`;

            statusMsg.innerText = `Processing (${i + 1}/${uploadedFiles.length}): ${file.name}`;
            
            ffmpeg.FS('writeFile', inName, await fetchFile(file));
            
            // PRO: Using -threads 4 for speed
            await ffmpeg.run('-threads', '4', '-i', inName, outName);

            const data = ffmpeg.FS('readFile', outName);
            
            if (useZip) {
                zip.file(finalDownloadName, data);
            } else {
                downloadBlob(data, finalDownloadName, targetFormat);
            }

            // Cleanup RAM for next file
            ffmpeg.FS('unlink', inName);
            ffmpeg.FS('unlink', outName);

            progBar.style.width = ((i + 1) / uploadedFiles.length * 100) + '%';
        }

        if (useZip) {
            statusMsg.innerText = "Generating ZIP archive...";
            const content = await zip.generateAsync({ type: "blob" });
            downloadBlob(content, "TurboConvert_Batch_Pro.zip", "zip");
        }

        statusMsg.innerText = "Batch Complete!";
        setTimeout(() => alert("All files processed successfully."), 500);
        startBtn.disabled = false;
    }

    function downloadBlob(data, name, format) {
        const blobType = format === 'zip' ? 'application/zip' : 'application/octet-stream';
        const url = URL.createObjectURL(new Blob([data.buffer || data], { type: blobType }));
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        a.click();
        URL.revokeObjectURL(url);
    }

    startBtn.addEventListener('click', processBatch);

</script>
</body>
</html>
