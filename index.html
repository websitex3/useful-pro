<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurboConvert PRO</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #080808; --card: #141414; --text: #ffffff; --border: #222; --primary: #00dc82; --error: #ff4d4d; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: var(--card); padding: 30px; border-radius: 24px; width: 680px; border: 1px solid var(--border); position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .pro-label { position: absolute; top: 25px; right: 25px; font-size: 10px; font-weight: 900; color: var(--primary); border: 1.5px solid var(--primary); padding: 3px 10px; border-radius: 6px; letter-spacing: 2px; }
        
        .step { display: none; }
        .step.active { display: block; }

        .upload-box { border: 2px dashed #333; padding: 60px; border-radius: 20px; cursor: pointer; text-align: center; transition: 0.3s; background: #0f0f0f; }
        .upload-box:hover { border-color: var(--primary); background: #1a1a1a; }

        #fileList { max-height: 350px; overflow-y: auto; margin: 20px 0; border-radius: 12px; border: 1px solid #222; background: #0a0a0a; }
        .file-row { display: grid; grid-template-columns: 1.5fr 1.2fr 80px 40px; gap: 10px; align-items: center; padding: 12px; border-bottom: 1px solid #222; }
        .file-row:last-child { border: none; }
        
        select, input[type="text"], button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px; outline: none; background: #1a1a1a; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: black; font-weight: bold; cursor: pointer; border: none; margin-top: 10px; transition: 0.2s; }
        button:hover { filter: brightness(1.1); }
        button:disabled { opacity: 0.4; }

        .btn-remove { background: rgba(255, 77, 77, 0.1); color: var(--error); border: 1px solid var(--error); padding: 5px; margin-top: 0; font-size: 16px; line-height: 1; cursor: pointer; border-radius: 6px; }
        .btn-remove:hover { background: var(--error); color: white; }

        .batch-controls { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid #333; }
        .options-flex { display: flex; gap: 20px; margin-bottom: 10px; font-size: 12px; color: #888; }
        
        .progress-wrapper { margin-top: 20px; display: none; }
        .progress-bar { width: 0%; height: 6px; background: var(--primary); transition: 0.3s; border-radius: 10px; box-shadow: 0 0 10px var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="pro-label">PRO</div>

    <div id="step1" class="step active">
        <h2 style="margin-top:0">TurboConvert</h2>
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00dc82" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <p>Upload Files for Batch Processing</p>
            <input type="file" id="fileInput" multiple style="display:none">
        </div>
    </div>

    <div id="step2" class="step">
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <h3 style="margin: 0;">Batch Queue</h3>
            <span id="fileCount" style="font-size: 12px; color: var(--primary);">0 files</span>
        </div>
        
        <div id="fileList"></div>

        <div class="batch-controls" id="batchControls">
            <div class="options-flex">
                <label><input type="checkbox" id="zipToggle"> Download as .ZIP</label>
                <label><input type="checkbox" id="masterSync" onchange="toggleSync(this)"> Sync All Formats</label>
            </div>
            <div id="globalFormatSelect" style="display:none; margin-top: 10px;">
                <select id="globalFormat" onchange="applyGlobalFormat(this.value)" style="border-color: var(--primary);">
                    <option value="" disabled selected>Select Master Format...</option>
                </select>
            </div>
        </div>

        <div class="progress-wrapper" id="progWrapper">
            <div id="statusMsg" style="font-size: 11px; text-align: center; margin-bottom: 5px; color: var(--primary);">Ready</div>
            <div style="background:#222; border-radius: 10px;"><div class="progress-bar" id="progBar"></div></div>
        </div>

        <button id="startBtn">Begin Batch Conversion</button>
        <button onclick="location.reload()" style="background:none; color:#555; border:none; margin-top:5px;">← Cancel All</button>
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: false });
    let queue = [];

    const formatData = {
        common: ['mp4', 'mp3', 'png', 'jpg', 'gif', 'webp'],
        video: ['mov', 'avi', 'mkv', 'flv'],
        audio: ['wav', 'flac', 'm4a', 'ogg', 'aac'],
        image: ['ico', 'bmp', 'tiff']
    };

    function generateFullOptions() {
        let html = '<optgroup label="COMMON (Top Pick)">';
        formatData.common.forEach(f => html += `<option value="${f}">${f.toUpperCase()}</option>`);
        html += '</optgroup>';
        
        html += '<optgroup label="VIDEO STREAMS">';
        formatData.video.forEach(f => html += `<option value="${f}">${f.toUpperCase()}</option>`);
        html += '</optgroup>';

        html += '<optgroup label="AUDIO STREAMS">';
        formatData.audio.forEach(f => html += `<option value="${f}">${f.toUpperCase()}</option>`);
        html += '</optgroup>';

        html += '<optgroup label="IMAGE ASSETS">';
        formatData.image.forEach(f => html += `<option value="${f}">${f.toUpperCase()}</option>`);
        html += '</optgroup>';
        return html;
    }

    // Initialize Global Select
    document.getElementById('globalFormat').innerHTML += generateFullOptions();

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        files.forEach((file, index) => {
            queue.push({
                file,
                id: Date.now() + index + Math.random(),
                newName: file.name.replace(/\.[^/.]+$/, ""),
                targetFormat: 'mp4'
            });
        });

        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        renderQueue();
    });

    function renderQueue() {
        const list = document.getElementById('fileList');
        document.getElementById('fileCount').innerText = `${queue.length} items`;
        if (queue.length === 0) { location.reload(); return; }

        list.innerHTML = queue.map(item => `
            <div class="file-row">
                <input type="text" value="${item.newName}" oninput="updateItem(${item.id}, 'newName', this.value)">
                <select onchange="updateItem(${item.id}, 'targetFormat', this.value)" class="row-format">
                    ${generateFullOptions()}
                </select>
                <span style="font-size:10px; color:#555;">${(item.file.size/1024/1024).toFixed(1)}MB</span>
                <button class="btn-remove" onclick="removeItem(${item.id})">×</button>
            </div>
        `).join('');

        // Ensure selects reflect the actual state
        document.querySelectorAll('.file-row').forEach((row, idx) => {
            row.querySelector('select').value = queue[idx].targetFormat;
        });
    }

    function removeItem(id) {
        queue = queue.filter(item => item.id !== id);
        renderQueue();
    }

    function updateItem(id, key, value) {
        const item = queue.find(i => i.id === id);
        if (item) item[key] = value;
    }

    function toggleSync(cb) {
        document.getElementById('globalFormatSelect').style.display = cb.checked ? 'block' : 'none';
    }

    function applyGlobalFormat(val) {
        queue.forEach(item => item.targetFormat = val);
        document.querySelectorAll('.row-format').forEach(sel => sel.value = val);
    }

    async function startConversion() {
        document.getElementById('progWrapper').style.display = 'block';
        document.getElementById('startBtn').disabled = true;
        const zip = new JSZip();
        const useZip = document.getElementById('zipToggle').checked;

        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        for (let i = 0; i < queue.length; i++) {
            const item = queue[i];
            const outName = `${item.newName}.${item.targetFormat}`;
            document.getElementById('statusMsg').innerText = `Encoding: ${item.file.name} → ${item.targetFormat.toUpperCase()}`;
            
            ffmpeg.FS('writeFile', item.file.name, await fetchFile(item.file));
            await ffmpeg.run('-threads', '4', '-i', item.file.name, outName);
            const data = ffmpeg.FS('readFile', outName);
            
            if (useZip && queue.length > 1) {
                zip.file(outName, data);
            } else {
                download(data, outName);
            }

            ffmpeg.FS('unlink', item.file.name);
            ffmpeg.FS('unlink', outName);
            document.getElementById('progBar').style.width = ((i+1)/queue.length * 100) + '%';
        }

        if (useZip && queue.length > 1) {
            document.getElementById('statusMsg').innerText = "Zipping results...";
            const content = await zip.generateAsync({type:"blob"});
            download(content, "TurboBatch_Export.zip");
        }

        document.getElementById('statusMsg').innerText = "All tasks complete!";
        document.getElementById('startBtn').disabled = false;
    }

    function download(data, name) {
        const blob = new Blob([data.buffer || data]);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
        URL.revokeObjectURL(url);
    }

    document.getElementById('startBtn').onclick = startConversion;
</script>
</body>
</html>
