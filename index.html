<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurboConvert PRO | Ultimate</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --bg: #080808; --card: #141414; --text: #ffffff; --border: #222; --primary: #00dc82; --error: #ff4d4d; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: var(--card); padding: 30px; border-radius: 24px; width: 750px; border: 1px solid var(--border); position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .pro-label { position: absolute; top: 25px; right: 25px; font-size: 10px; font-weight: 900; color: var(--primary); border: 1.5px solid var(--primary); padding: 3px 10px; border-radius: 6px; letter-spacing: 2px; }
        
        .step { display: none; }
        .step.active { display: block; }

        .upload-box { border: 2px dashed #333; padding: 60px; border-radius: 20px; cursor: pointer; text-align: center; transition: 0.3s; background: #0f0f0f; }
        .upload-box:hover { border-color: var(--primary); background: #1a1a1a; }

        #fileList { max-height: 350px; overflow-y: auto; margin: 20px 0; border-radius: 12px; border: 1px solid #222; background: #0a0a0a; }
        .file-row { display: grid; grid-template-columns: 1.2fr 80px 1fr 80px 40px; gap: 12px; align-items: center; padding: 12px; border-bottom: 1px solid #222; }
        
        select, input[type="text"], button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px; outline: none; background: #1a1a1a; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: black; font-weight: bold; cursor: pointer; border: none; transition: 0.2s; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .source-badge { font-size: 9px; background: #222; color: #888; padding: 4px 6px; border-radius: 4px; text-align: center; font-weight: bold; border: 1px solid #333; }
        .btn-remove { background: rgba(255, 77, 77, 0.1); color: var(--error); border: 1px solid var(--error); cursor: pointer; font-weight: bold; }
        .btn-remove:hover { background: var(--error); color: white; }

        .batch-header { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .batch-footer { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 10px; margin-top: 15px; }
        
        .checkbox-group { display: flex; gap: 20px; margin: 10px 0; font-size: 12px; color: #888; }
        .checkbox-group input { accent-color: var(--primary); }

        .progress-wrapper { margin-top: 20px; display: none; }
        .progress-bar { width: 0%; height: 6px; background: var(--primary); transition: 0.1s linear; border-radius: 10px; box-shadow: 0 0 10px var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="pro-label">PRO</div>

    <div id="step1" class="step active">
        <h2 style="margin-top:0">TurboConvert</h2>
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00dc82" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <p>Select Files to Convert</p>
            <input type="file" id="fileInput" multiple style="display:none">
        </div>
    </div>

    <div id="step2" class="step">
        <div class="batch-header">
            <div style="flex: 1;">
                <label style="font-size: 10px; color: var(--primary); font-weight: bold; letter-spacing: 1px;">SET ALL TO:</label>
                <select id="masterSelector" onchange="syncAllFormats(this.value)" style="border-color: #444; margin-top: 5px;">
                    <option value="custom" disabled selected>-- Multiple Formats --</option>
                </select>
            </div>
            <div style="text-align: right; margin-left: 20px;">
                <div id="totalSize" style="font-size: 14px; font-weight: bold;">0.00 MB</div>
                <div style="font-size: 10px; color: #666;">TOTAL BATCH SIZE</div>
            </div>
        </div>
        
        <div id="fileList"></div>

        <div class="checkbox-group">
            <label title="Downloads one ZIP instead of many files"><input type="checkbox" id="zipMode"> Bundle as .ZIP</label>
            <label><input type="checkbox" id="folderMode"> Folder Mode</label>
        </div>

        <div class="progress-wrapper" id="progWrapper">
            <div id="statusMsg" style="font-size: 11px; text-align: center; margin-bottom: 5px; color: var(--primary);">Initialising FFmpeg Core...</div>
            <div style="background:#222; border-radius: 10px;"><div class="progress-bar" id="progBar"></div></div>
        </div>

        <div class="batch-footer">
            <button id="startBtn">START BATCH CONVERSION</button>
            <button onclick="location.reload()" style="background:none; color:#555; border:1px solid #333;">CANCEL</button>
        </div>
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: false });
    let queue = [];
    let currentFileRatio = 0;

    const formatData = {
        common: ['mp4', 'mp3', 'png', 'jpg', 'gif', 'webp'],
        video: ['mov', 'avi', 'mkv', 'webm'],
        audio: ['wav', 'flac', 'm4a', 'aac'],
        image: ['ico', 'bmp', 'tiff']
    };

    function generateOptionsHTML() {
        let html = '';
        html += `<optgroup label="COMMON">` + formatData.common.map(f => `<option value="${f}">${f.toUpperCase()}</option>`).join('') + `</optgroup>`;
        html += `<optgroup label="VIDEO">` + formatData.video.map(f => `<option value="${f}">${f.toUpperCase()}</option>`).join('') + `</optgroup>`;
        html += `<optgroup label="AUDIO">` + formatData.audio.map(f => `<option value="${f}">${f.toUpperCase()}</option>`).join('') + `</optgroup>`;
        html += `<optgroup label="IMAGE">` + formatData.image.map(f => `<option value="${f}">${f.toUpperCase()}</option>`).join('') + `</optgroup>`;
        return html;
    }

    document.getElementById('masterSelector').innerHTML += generateOptionsHTML();

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach((file, idx) => {
            const ext = file.name.split('.').pop().toUpperCase();
            queue.push({
                file,
                id: Date.now() + idx + Math.random(),
                newName: file.name.replace(/\.[^/.]+$/, ""),
                format: 'mp4',
                sourceExt: ext
            });
        });
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        renderQueue();
    });

    function renderQueue() {
        const list = document.getElementById('fileList');
        let total = 0;
        if (queue.length === 0) { location.reload(); return; }

        list.innerHTML = queue.map(item => {
            total += item.file.size;
            return `
            <div class="file-row">
                <input type="text" value="${item.newName}" oninput="updateItem(${item.id}, 'newName', this.value)">
                <div class="source-badge">FROM ${item.sourceExt}</div>
                <select onchange="updateIndividualFormat(${item.id}, this.value)" class="row-format">
                    ${generateOptionsHTML().replace(`value="${item.format}"`, `value="${item.format}" selected`)}
                </select>
                <span style="font-size:11px; color:#555; text-align:right;">${(item.file.size/1024/1024).toFixed(1)} MB</span>
                <button class="btn-remove" onclick="removeItem(${item.id})">Ã—</button>
            </div>`;
        }).join('');

        document.getElementById('totalSize').innerText = (total / 1024 / 1024).toFixed(2) + " MB";
    }

    function removeItem(id) {
        queue = queue.filter(i => i.id !== id);
        renderQueue();
    }

    function updateItem(id, key, value) {
        const item = queue.find(i => i.id === id);
        if (item) item[key] = value;
    }

    function updateIndividualFormat(id, value) {
        updateItem(id, 'format', value);
        document.getElementById('masterSelector').value = "custom";
    }

    function syncAllFormats(val) {
        queue.forEach(item => item.format = val);
        document.querySelectorAll('.row-format').forEach(sel => sel.value = val);
    }

    async function startConversion() {
        document.getElementById('progWrapper').style.display = 'block';
        document.getElementById('startBtn').disabled = true;
        const zip = new JSZip();
        const useZip = document.getElementById('zipMode').checked;

        if (!ffmpeg.isLoaded()) await ffmpeg.load();

        // Fluid Progress Hook
        ffmpeg.setProgress(({ ratio }) => {
            currentFileRatio = ratio;
            updateProgressBar(currentIdx);
        });

        let currentIdx = 0;
        for (currentIdx = 0; currentIdx < queue.length; currentIdx++) {
            const item = queue[currentIdx];
            const outName = `${item.newName}.${item.format}`;
            document.getElementById('statusMsg').innerText = `Step ${currentIdx+1}/${queue.length}: Processing ${item.file.name}...`;
            
            // Memory Management: Clear FS before writing new large file
            try { ffmpeg.FS('unlink', item.file.name); } catch(e){}

            ffmpeg.FS('writeFile', item.file.name, await fetchFile(item.file));
            
            // OOM Prevention: Use slower but safer memory profile for large files
            const isLarge = item.file.size > 200 * 1024 * 1024;
            const args = isLarge 
                ? ['-i', item.file.name, '-preset', 'ultrafast', '-threads', '2', outName]
                : ['-threads', '4', '-i', item.file.name, outName];

            await ffmpeg.run(...args);
            
            const data = ffmpeg.FS('readFile', outName);
            
            if (useZip) {
                zip.file(outName, data);
            } else {
                download(data, outName);
            }

            // Forced Garbage Collection
            ffmpeg.FS('unlink', item.file.name);
            ffmpeg.FS('unlink', outName);
        }

        if (useZip) {
            document.getElementById('statusMsg').innerText = "Bundling ZIP...";
            const content = await zip.generateAsync({type:"blob"});
            download(content, "TurboBatch_Pro.zip");
        }

        document.getElementById('statusMsg').innerText = "All Complete!";
        document.getElementById('startBtn').disabled = false;
    }

    function updateProgressBar(idx) {
        // Math: (Completed Files / Total) + (Current File Progress / Total)
        const totalFiles = queue.length;
        const baseProgress = (idx / totalFiles) * 100;
        const currentFileProgress = (currentFileRatio / totalFiles) * 100;
        const finalWidth = baseProgress + currentFileProgress;
        document.getElementById('progBar').style.width = finalWidth + '%';
    }

    function download(data, name) {
        const blob = new Blob([data.buffer || data]);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; a.click();
        
        // Memory Fix: Immediately free the Blob URL from browser RAM
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    document.getElementById('startBtn').onclick = startConversion;
</script>
</body>
</html>
